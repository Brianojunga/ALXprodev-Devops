#!/bin/bash

POKEMONS=("Bulbasaur" "Ivysaur" "Venusaur" "Charmander" "Charmeleon")
API_URL="https://pokeapi.co/api/v2/pokemon"
TIMEOUT=8   # seconds

# Directory for JSON outputs
mkdir -p pokemon_data

fetch_pokemon() {
    local name=$(echo "$1" | tr '[:upper:]' '[:lower:]')
    local outfile="pokemon_data/${name}.json"

    echo "Fetching $name..."

    # Run curl in background with PID capture
    curl -s "$API_URL/$name" > "$outfile" &
    pid=$!

    # Store PID + name
    echo "$pid $name" >> process_list.txt

    # Enforce timeout
    sleep "$TIMEOUT"

    # If still running, kill it
    if kill -0 "$pid" 2>/dev/null; then
        echo "Timeout reached — killing $name process"
        kill "$pid"
    fi
}

# Clean previous process list
> process_list.txt

# Start all fetches in parallel
for pokemon in "${POKEMONS[@]}"; do
    fetch_pokemon "$pokemon" &
done

# Wait for all active processes
while read -r pid pname; do
    if kill -0 "$pid" 2>/dev/null; then
        echo "Waiting for $pname (PID $pid)..."
        wait "$pid"
    fi
done < process_list.txt

echo "All Pokémon data fetched successfully."
rm process_list.txt
